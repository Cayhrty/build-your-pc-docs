# 单周期 CPU 的设计思路

- [单周期 CPU 的设计思路](#%e5%8d%95%e5%91%a8%e6%9c%9f-cpu-%e7%9a%84%e8%ae%be%e8%ae%a1%e6%80%9d%e8%b7%af)
  - [基本的数据通路图](#%e5%9f%ba%e6%9c%ac%e7%9a%84%e6%95%b0%e6%8d%ae%e9%80%9a%e8%b7%af%e5%9b%be)
  - [主要控制逻辑的真值表](#%e4%b8%bb%e8%a6%81%e6%8e%a7%e5%88%b6%e9%80%bb%e8%be%91%e7%9a%84%e7%9c%9f%e5%80%bc%e8%a1%a8)

## 基本的数据通路图

在数据通路图中，主要的数据通路包括：

- 指令存储器（Instruction Memory）
- 数据存储器（Data Memory）
- 寄存器堆（Register File）
- 指令寄存器（Instruction Register）
- 程序计数器（Program Counter）
- 控制单元（Control Unit）

具体数据通路图大致如下：

![](https://i.loli.net/2019/09/01/yac4B6bqeUx5kRM.png)

其中，主要的逻辑控制信号 Control Signals（蓝色）有：

|    信号    |                                                   功能                                                    |
| :--------: | :-------------------------------------------------------------------------------------------------------: |
| `RegWrite` |                                             写寄存器使能信号                                              |
| `MemWrite` |                                           读数据存储器使能信号                                            |
| `MemRead`  |                                           写数据存储器使能信号                                            |
|  `ALUOp`   |                            ALU 控制信号（区分算术指令，比如 `ADD`、`SUB` 等）                             |
| `MemToReg` |              选择将 ALU 计算结果（00）、数据存储器输出（01）或 LUI 指令结果（10）存入寄存器               |
|  `RegDst`  |               目标寄存器 rt（0）、rd（1）二选一（由于 `LW` 指令目标寄存器是 rt 而不是 rd）                |
|  `ALUSrc`  | ALU 源操作数二选一 - 来自寄存器（0）或**符号扩展**的立即数（1）（区分算术指令结果与 `LW`、`SW` 指令结果） |
|  `PCSrc`   |  `BEQ` 根据 `Zero` 结果进行跳转，相等（00）则不跳转继续执行，不等（10）则跳转；若位 `J` 则直接跳转（01）  |

由于需要：

- 实现 `LUI`，需要将 16 位立即数 imm 写入寄存器 rt 的高 16 位，因此单独设置「Shift Left by 16」的单元，从而将 32 位的结果输出至 `MemToReg` 的 `10` 输入端口并写入 rt
- 实现 `BEQ` 和 `J`，立即数的位数不一样，因此 15 - 0 位的 `imm16` 代表 `BEQ` 指令的偏移量，25 - 0 位的 `imm26` 代表 `J` 指令的偏移量
- 实现 `BEQ`，需要将 rs、rt 寄存器的值相减得到并判断是否为 0，因此引入 `Zero` 控制信号，用来判断是否跳转

## 主要控制逻辑的真值表

![](https://i.loli.net/2019/08/30/7ZT3EGtizg9FmWJ.png)

其中，对于算术指令我们只需要实现加法和减法，`ALUOp` 功能表如下：

| `ALUOp[2..0]` | 功能  | 描述  |
| :-----------: | :---: | :---: |
|      001      | Y=A+B |  加   |
|      010      | Y=A-B |  减   |

为了方便后续扩展，我设计的 `ALUOp` 有三位。

---

[👈 Previous](./2-1_Basic.md) | [👉 Next](./2-3_Verilog.md) | [🚩 Home](../README.md)