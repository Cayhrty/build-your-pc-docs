[👈 Previous](./3-1_Basic.md) · [👉 Next](./3-3_Hazards.md) · [🚩 Home](../README.md)

# 数据通路与信号控制

- [数据通路与信号控制](#%e6%95%b0%e6%8d%ae%e9%80%9a%e8%b7%af%e4%b8%8e%e4%bf%a1%e5%8f%b7%e6%8e%a7%e5%88%b6)
  - [对「单周期 CPU」数据通路的修改](#%e5%af%b9%e5%8d%95%e5%91%a8%e6%9c%9f-cpu%e6%95%b0%e6%8d%ae%e9%80%9a%e8%b7%af%e7%9a%84%e4%bf%ae%e6%94%b9)
    - [寄存器堆](#%e5%af%84%e5%ad%98%e5%99%a8%e5%a0%86)
    - [流水线寄存器](#%e6%b5%81%e6%b0%b4%e7%ba%bf%e5%af%84%e5%ad%98%e5%99%a8)
  - [将数据经由流水线寄存器前递](#%e5%b0%86%e6%95%b0%e6%8d%ae%e7%bb%8f%e7%94%b1%e6%b5%81%e6%b0%b4%e7%ba%bf%e5%af%84%e5%ad%98%e5%99%a8%e5%89%8d%e9%80%92)
  - [将控制信号经由流水线寄存器前递](#%e5%b0%86%e6%8e%a7%e5%88%b6%e4%bf%a1%e5%8f%b7%e7%bb%8f%e7%94%b1%e6%b5%81%e6%b0%b4%e7%ba%bf%e5%af%84%e5%ad%98%e5%99%a8%e5%89%8d%e9%80%92)

## 对「单周期 CPU」数据通路的修改

流水线 CPU 的提高吞吐量的主要方法就是「让多条指令同时执行」。因此，我们需要在同一个时钟周期内进行多项操作，比如：

- 同时让 PC 自增、与计算两个寄存器之和
- 在取指令的同时执行另外一条指令的读写操作

因此，对于「流水线 CPU」来说，我们也需要复制硬件元件，来让同一个时钟周期中需要多次使用到的硬件能够同时运转。

### 寄存器堆

<img src="https://i.loli.net/2019/09/04/VdAXaNBw1LpT5Fm.png" width="160px" align="right">

对于寄存器堆来说，我们只需要一个寄存器堆就能支持 ID 和 WB 阶段，因为「写入」和「读取」分别是通过寄存器堆的不同端口进行的；同时，「写入」操作只发生在一个时钟周期的前半段，而「读取」操作只发生在后半段。

### 流水线寄存器

流水线寄存器：Pipeline registers，用来控制整个数据通路中不同流水阶段里信号、数据的传递。五级流水分为 IF、ID、EX、MEM 和 WB 五个阶段，我们分别设置 IF/ID、ID/EX、EX/MEM、MEM/WB 这四个流水线寄存器，用来连接流水的五个阶段。

为了方便描述，我们将数据通路精简为如下图所示：

![](https://i.loli.net/2019/09/04/sZuUGLXpPh67qYM.png)

## 将数据经由流水线寄存器前递

在后面阶段所需要的数据必须经由流水线寄存器进行前递。比如 LW 指令需要将数据存储器中的数据写入目标寄存器中，目标寄存器最终写入的数据是由指令在第四阶段 MEM 才获取到的，而在第五阶段 WB 才写回。因此，rd（目标寄存器）必须经由全部四个流水线寄存器前递，如下图标红部分所示：

![](https://i.loli.net/2019/09/04/fuKn2cYEwiNJvGD.png)

## 将控制信号经由流水线寄存器前递

控制信号也需要进行前递。值得注意的是，控制信号的生成与单周期 CPU 中的生成过程一致：在取指令之后，ID 模块对指令译码并生成相应的控制信号。但是和之前情况一样的是，这些控制信号很多时候一直到指令执行的第五流水阶段才会用到，因此控制信号可以随着其他数据一同在流水线寄存器中进行前递。

我们根据流水线的阶段将控制信号进行分类：

![](https://i.loli.net/2019/09/04/t1v5WXGblO3QwaE.png)

这样我们就也可以将控制信号一同进行前递：

![](https://i.loli.net/2019/09/04/fe5nGVjH6cWOsXu.png)

[👈 Previous](./3-1_Basic.md) · [👉 Next](./3-3_Hazards.md) · [🚩 Home](../README.md)